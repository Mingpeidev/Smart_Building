<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<link rel="stylesheet" href="../assets/css/layui.css">
<link rel="stylesheet" href="../assets/css/view.css" />
<title></title>
<script type="text/javascript" src="../js/jquery.js"></script>
<script type="text/javascript" src="../js/highcharts.js"></script>

<script type="text/javascript">

	Highcharts.setOptions({
		global : {
			useUTC : false
		}
	}); //修改时区
	var temp = [];
	var humi = [];
	var light = [];
	var time = [];

	$.ajaxSetup({
		async : false
	});
	$.getJSON('/Smart_Building/user/getSensorList', function(list) { //只获取最近10组数据
		var i;
		len = list.length;
		if (len > 10) {
			for (i = len - 10; i < len; i++) {

				temp.push(Number(list[i].temp));
				humi.push(Number(list[i].humi));
				light.push(Number(list[i].light));
				time.push(Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', Number(list[i].time)))

			}
		} else {
			for (i = 0; i < len; i++) {

				temp.push(Number(list[i].temp));
				humi.push(Number(list[i].humi));
				light.push(Number(list[i].light));
				time.push(Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', Number(list[i].time)))

			}
		}
	});
</script>



<script type="text/javascript">

	$(function() {
		var chart = new Highcharts.Chart({
			chart : {
				renderTo : 'container',
				type : 'line'
			},
			title : {
				text : '温湿度折线图'
			},
			subtitle : {
				text : '数据来源: mao'
			},
			xAxis : {
				categories : time
			},
			yAxis : {
				title : {
					text : '温度 (°C)/湿度(%RH)'
				}
			},
			tooltip : {
				formatter : function() {
					return '<b>' + this.series.name + '</b><br/>' +
						'<b>' + this.x + '</b><br/>' +
						Highcharts.numberFormat(this.y, 1);
				}
			},
			plotOptions : {
				line : {
					dataLabels : {
						enabled : true // 开启数据标签
					},
					enableMouseTracking : true // 关闭鼠标跟踪，对应的提示框、点击事件会失效
				}
			},
			series : [ {
				name : '温度(°C)',
				data : temp
			}, {
				name : '湿度(%RH)',
				data : humi
			} ]
		});
	});
</script>

</head>
<body class="layui-view-body">
	<div class="layui-content">
		<div class="layui-row layui-col-space20">
			<div class="layui-col-sm6 layui-col-md2">
				<div class="layui-card">
					<div class="layui-card-body chart-card">
						<div class="chart-header">
							<div class="metawrap">
								<div class="meta">
									<span>温度</span>
								</div>
								<div class="total">
									<span id="temp" style="font-size:24px">未获取</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="layui-col-sm6 layui-col-md2">
				<div class="layui-card">
					<div class="layui-card-body chart-card">
						<div class="chart-header">
							<div class="metawrap">
								<div class="meta">
									<span>湿度</span>
								</div>
								<div class="total">
									<span id="humi" style="font-size:24px">未获取</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="layui-col-sm6 layui-col-md2">
				<div class="layui-card">
					<div class="layui-card-body chart-card">
						<div class="chart-header">
							<div class="metawrap">
								<div class="meta">
									<span>光照度</span>
								</div>
								<div class="total">
									<span id="light" style="font-size:24px">未获取</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="layui-col-sm6 layui-col-md2">
				<div class="layui-card">
					<div class="layui-card-body chart-card">
						<div class="chart-header">
							<div class="metawrap">
								<div class="meta">
									<span>灯</span>
								</div>
								<div class="total">
									<span id="lamp_text" style="font-size:24px">未获取</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="layui-col-sm6 layui-col-md2">
				<div class="layui-card">
					<div class="layui-card-body chart-card">
						<div class="chart-header">
							<div class="metawrap">
								<div class="meta">
									<span>空调</span>
								</div>
								<div class="total">
									<span id="air_text" style="font-size:24px">未获取</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="layui-col-sm6 layui-col-md2">
				<div class="layui-card">
					<div class="layui-card-body chart-card">
						<div class="chart-header">
							<div class="metawrap">
								<div class="meta">
									<span>报警器</span>
								</div>
								<div class="total">
									<span id="alarm_text" style="font-size:24px">未获取</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="layui-col-sm6 layui-col-md2">
				<div class="layui-card">
					<div class="layui-card-body chart-card">
						<div class="chart-header">
							<div class="metawrap">
								<div class="meta">
									<span>门</span>
								</div>
								<div class="total">
									<span id="door_text" style="font-size:24px">未获取</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="layui-col-sm12 layui-col-md12">
				<div class="layui-card">
					<div class="layui-tab layui-tab-brief">
						<ul class="layui-tab-title">
							<li class="layui-this">实时数据</li>
							<li>实时曲线</li>
						</ul>
						<div class="layui-tab-content">
							<div class="layui-tab-item layui-show">
								<button class="layui-btn layui-btn-radius layui-btn-normal"
									onclick="Lamp_click()">
									<span id="lamp_btn">灯开关</span>
								</button>
								<button class="layui-btn layui-btn-radius layui-btn-normal"
									onclick="Air_click()">
									<span id="air_btn">空调开关</span>
								</button>
								<button class="layui-btn layui-btn-radius layui-btn-normal"
									onclick="Door_click()">
									<span id="door_btn">门开关</span>
								</button>

								<table id="sensortable"></table>
							</div>
							<div class="layui-tab-item">

								<div id="container"
									style="width:1000px;height:400px;margin:0 auto;"></div>
								<div style="text-align:center;clear:both;"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="../assets/layui.all.js"></script>
	<script>
		var element = layui.element;
		var table = layui.table;
		var util = layui.util;
	
		//展示已知数据
		table.render({
			elem : '#sensortable',
			url : '/Smart_Building/user/getSensorMap',
			cols : [ [ //标题栏
				{
					field : 'id',
					title : 'ID',
					sort : true
				}
				, {
					field : 'temp',
					title : '温度',
				}
				, {
					field : 'humi',
					title : '湿度',
				}
				, {
					field : 'light',
					title : '光照度',
				}
				, {
					field : 'time',
					title : '时间',
					templet : function(d) {
						return util.toDateString(d.time, "yyyy-MM-dd HH:mm:ss");
					}
				}
			] ],
			skin : 'line', //表格风格
			even : true,
			page : true, //是否显示分页
			limits : [ 5, 7, 10 ],
			limit : 5 //每页默认显示的数量
		});
	</script>
	<script type="text/javascript">
		if (len > 10) {
			document.getElementById('temp').innerHTML = temp[9] + "℃";
			document.getElementById('humi').innerHTML = humi[9] + "%";
			document.getElementById('light').innerHTML = light[9];
		} else {
			document.getElementById('temp').innerHTML = temp[len - 1] + "℃";
			document.getElementById('humi').innerHTML = humi[len - 1] + "%";
			document.getElementById('light').innerHTML = light[len - 1];
		}
	</script>

	<script type="text/javascript">
		setInterval("getData()", 1000); //定时刷新局部信息
		var lamp_control,
			air_control,
			alarm_control,
			door_control;
		var human,
			smoke,
			lamp,
			air,
			alarm,
			door;
		function getData() {
			$.ajaxSetup({
				async : false
			});
	
			$.getJSON('/Smart_Building/user/getRealtimedata', function(map) {
				var i;
				lamp = map.lamp;
				air = map.air;
				alarm = map.alarm;
				door = map.door;
	
			});
			if (lamp == "1") {
				document.getElementById('lamp_text').innerHTML = "运行中";
				document.getElementById('lamp_btn').innerHTML = "关闭灯";
				lamp_control = "0";
			} else if (lamp == "0") {
				document.getElementById('lamp_text').innerHTML = "关闭中";
				document.getElementById('lamp_btn').innerHTML = "打开灯";
				lamp_control = "1";
			}
			if (air == "1") {
				document.getElementById('air_text').innerHTML = "运行中";
				document.getElementById('air_btn').innerHTML = "关闭空调";
				air_control = "0";
			} else if (air == "0") {
				document.getElementById('air_text').innerHTML = "关闭中";
				document.getElementById('air_btn').innerHTML = "打开空调";
				air_control = "1";
			}
			if (door == "1") {
				document.getElementById('door_text').innerHTML = "运行中";
				document.getElementById('door_btn').innerHTML = "关闭门";
				door_control = "0";
			} else if (door == "0") {
				document.getElementById('door_text').innerHTML = "关闭中";
				document.getElementById('door_btn').innerHTML = "打开门";
				door_control = "1";
			}
		}
	</script>

	<script type="text/javascript">
		function Lamp_click() {
			$.ajax({
				type : 'POST',
				url : '/Smart_Building/user/Sensorcontrol',
				data : {
					lamp : lamp_control,
					air : air,
					alarm : alarm,
					door : door
				},
				dataType : "json", //返回数据形式为json
				success : function(map) {
					if (map.data == "success") {
						layer.msg(map.data);
					} else {
						layer.msg("失败:" + map.data);
					}
				},
			});
		}
		function Air_click() {
			$.ajax({
				type : 'POST',
				url : '/Smart_Building/user/Sensorcontrol',
				data : {
					lamp : lamp,
					air : air_control,
					alarm : alarm,
					door : door
				},
				dataType : "json", //返回数据形式为json
				success : function(map) {
					if (map.data == "success") {
						layer.msg(map.data);
					} else {
						layer.msg("失败:" + map.data);
					}
				},
			});
		}
		function Door_click() {
			$.ajax({
				type : 'POST',
				url : '/Smart_Building/user/Sensorcontrol',
				data : {
					lamp : lamp,
					air : air,
					alarm : alarm,
					door : door_control
				},
				dataType : "json", //返回数据形式为json
				success : function(map) {
					if (map.data == "success") {
						layer.msg(map.data);
					} else {
						layer.msg("失败:" + map.data);
					}
				},
			});
		}
	</script>
</body>
</html>